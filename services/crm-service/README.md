# CRM Service (@easycode/crm-service)

This service provides a comprehensive platform for managing all aspects of customer relationships, including lead and contact management, sales automation, multi-channel communication, marketing campaigns, and customer service interactions. It is designed to be adaptable for various business needs, with initial feature focus guided by requirements for clients like Stema.

## Core Responsibility
To manage leads, contacts, accounts (organizations/companies), sales activities, sales pipeline, marketing campaigns, multi-channel customer communications (forming a comprehensive knowledge base), and basic customer service interactions.

## Data Models for Key Features (Stema Focus)

The following data models are central to providing Stema with its required customer knowledge base and employee referral capabilities. All data is tenant-isolated.

### 1. Communication Logging Data Models (Customer Knowledge Base)
A base `Activity` concept captures common metadata for all communications, with specific types for detailed logging:
-   **Common `Activity` Metadata**: Includes `activityId`, `tenantId`, `contactId` (FK), `accountId` (FK), `userId` (Stema employee involved), `activityTimestamp` (when event occurred), `direction` (inbound/outbound/internal), `summary`, and `visibility` (e.g., private, team, tenant-wide).
-   **`EmailActivity`**: Tracks subject, from/to/cc/bcc, body preview, email gateway IDs, thread ID, and attachment information. Full email bodies and large attachments are stored in object storage (e.g., Cloudflare R2) with a `bodyStorageRef` or `attachmentStorageRef` in the database.
-   **`CallActivity`**: Logs phone number, duration, call outcome, and references (`recordingStorageRef`, `callNotesStorageRef`) to recordings or detailed notes in object storage.
-   **`SmsActivity` & `WhatsAppActivity`**: Store message bodies (or references for long messages), from/to identifiers, delivery status, gateway message IDs, and media attachment details (with large media in object storage). WhatsApp activities also track `conversationId` and `messageType`.
-   **`NoteActivity` (Internal)**: For internal Stema employee notes related to contacts/accounts, with optional title and content stored directly or in object storage (`noteContentStorageRef`) for rich text. Supports pinning.
-   **`MeetingActivity`**: Details meeting subject, start/end times, location, internal/external attendees, and a reference (`meetingNotesStorageRef`) to detailed notes or agendas in object storage.
*This structured and comprehensive activity logging, with efficient storage of large content, directly enables Stema's requirement for a robust customer knowledge base, allowing any employee to review past interactions and get up to speed.*

### 2. Lead Data Model Enhancements for Referrals
To support Stema's goal of employee-driven lead generation:
-   **`Lead` Entity Additions**:
    -   `referred_by_employee_id` (UUID, Nullable, FK to `user-service.Users.userId`): Stores the ID of the Stema employee who made the referral. Indexed for querying.
    -   `referral_details` (Text, Nullable): Captures notes about the referral.
-   **`lead_source` Field**: Configured to include "Internal Employee Referral" as a distinct source.
*These fields allow Stema to track leads generated by their employees, forming the basis for recognition and reward programs.*

## Key API Endpoints (Stema Focus)

The following API endpoints are crucial for Stema's operational needs. All endpoints are versioned (e.g., `/v1/...`) and require authentication/authorization. `tenantId` is derived from the user's session.

### 1. Logging Communication Activities
Used by various system components (email sync, telephony integration, UI) to populate the customer knowledge base.
-   `POST /v1/activities/emails` - Logs an email activity.
-   `POST /v1/activities/calls` - Logs a call activity.
-   `POST /v1/activities/sms` - Logs an SMS activity.
-   `POST /v1/activities/whatsapp` - Logs a WhatsApp activity.
-   `POST /v1/activities/notes` - Logs an internal note.
-   `POST /v1/activities/meetings` - Logs a meeting activity.
*Request payloads correspond to the data models described above. These enable comprehensive capture of Stema's customer interactions.*

### 2. Retrieving Communication History (Activity Feed)
Essential for Stema employees to review interaction history.
-   `GET /v1/contacts/{contactId}/activity-feed`
-   `GET /v1/accounts/{accountId}/activity-feed`
-   **Key Query Parameters**: `type` (email, call, etc.), `direction`, `userId` (Stema employee), `dateFrom`, `dateTo`, `searchTerm`, `visibility`, `sortBy`, `sortOrder`, pagination.
-   **Response**: Paginated, polymorphic list of `Activity` objects with an `activityType` discriminator.
*These endpoints provide Stema with powerful tools to access and filter the complete communication history for any contact or account, fulfilling the knowledge base requirement.*

### 3. Lead Management APIs for Referrals
Supports Stema's employee lead generation program.
-   `POST /v1/leads`: Request body accepts `referred_by_employee_id` and `referral_details`. Any authenticated Stema user (with basic create-lead permission) can submit.
-   `GET /v1/leads`: Enhanced with query parameters like `referredByEmployeeId`, `isReferred=true`, and filtering by `leadSource="Internal Employee Referral"`.
-   `GET /v1/reports/employee-lead-referrals` (Conceptual): Dedicated endpoint for aggregated referral performance data (e.g., leads per employee, conversion rates of referred leads).
*These APIs allow Stema to effectively manage and report on its employee referral program.*

### 4. Event-Driven Workflow for Referral Bonus
-   **Event**: `crm-service` publishes a `LeadReferredAndConverted` event when a lead with a `referred_by_employee_id` is marked as "Converted".
-   **Payload**: Includes `leadId`, `convertedValue` (optional), `referredByEmployeeId`, etc.
-   **Decoupling**: This event can be consumed by other services (e.g., a dedicated bonus processor, HR, or Finance service) to handle Stema's employee reward logic without tightly coupling it to the CRM.
*This ensures Stema's referral reward process can be integrated smoothly.*

## General Modules & Key Features (Beyond Stema's Immediate Focus)

While the above sections detail Stema-specific requirements, the `crm-service` also includes broader functionalities:

### 1. Lead Management (General)
-   Lead capture (web forms, API, import)
-   Customizable lead qualification & scoring rules
-   Automated lead assignment (round-robin, rule-based)
-   Lead nurturing sequences
-   Duplicate detection & merging
-   Conversion tracking (to opportunity/contact/account)

### 2. Contact & Account Management (General)
-   360-degree view of contacts and accounts (organizations)
-   Customizable fields and page layouts
-   Relationship mapping (e.g., key contacts, reporting structures, inter-account relationships)
-   Activity timelines (all interactions - powered by the Activity Logging models)
-   Data import/export
-   Segmentation tools
-   Data enrichment capabilities (future)

### 3. Sales Pipeline & Opportunity Management
-   Multiple customizable sales pipelines
-   Drag-and-drop deal stage management
-   Opportunity tracking (value, probability, expected close date, key stakeholders)
-   Sales forecasting
-   Quote generation (basic)
-   Sales activity management

### 4. Unified Communications Center & Channel Modules (General - as per Activity Logging)
-   Integrations for Email, Telephony, SMS, WhatsApp to feed into the Activity Logging system.
-   Shared team inboxes (conceptually part of Email Collaboration)
-   Advanced email templates with personalization
-   Email tracking (opens, clicks, bounces)
-   Automated email sequences

### 5. Marketing Automation
-   Multi-step marketing campaign builder (email, SMS, potentially social)
-   Audience segmentation for campaigns
-   A/B testing for emails/landing pages
-   Landing page builder or integration
-   Lead capture forms for campaigns
-   Marketing ROI analytics
-   Basic social media posting/monitoring (future)

### 6. Workflow Automation Engine
-   Rule-based automation for routine tasks (e.g., "if lead score > X, assign to Senior Sales Rep and create follow-up task")
-   Automated email/SMS alerts based on triggers
-   Field updates based on criteria
-   Approval process automation

### 7. Reporting & Analytics (General)
-   Customizable dashboards for sales, marketing, and service
-   Advanced report builder with drag-and-drop interface
-   Sales performance analytics (quota attainment, pipeline velocity)
-   Marketing campaign effectiveness
-   Customer lifecycle analytics
-   Data export options

### 8. Customer Service/Support Ticketing (Lite)
-   Basic case/ticket creation from emails or manual entry
-   Ticket assignment to agents/teams
-   Status tracking
-   Internal comments on tickets
-   Linking tickets to customer records
-   Basic knowledge base integration (or a simple internal FAQ system)
    *(Note: If this becomes very complex, it could justify its own `customer-support-service`)*

### 9. Administration & Customization
-   User role and permission management (integrated with `user-service`)
-   Audit trails
-   Custom object creation (basic, future)
-   API access and management
-   Integration marketplace/settings for third-party tools

## Potential AI Enhancements
The `crm-service` is planned to incorporate several AI-driven features to enhance its capabilities. These include:
-   **Predictive Lead Scoring**: To help sales teams prioritize leads.
-   **Sales Forecast Automation & Deal Insights**: For more accurate forecasting and actionable deal intelligence.
-   **Customer Sentiment Analysis**: To understand customer sentiment from communications.
-   **Intelligent Product/Service Recommendations**: To assist with cross-selling and upselling.
-   **Automated Communication Summarization**: To quickly digest long text communications and extract action items.

## Key Integrations
This service will integrate with:
- `user-service` for authentication/authorization.
- `notification-service` for dispatching certain types of system alerts (though many communications will be direct via its own modules or activity logging).
- `tenant-service` for data isolation and tenant-specific configurations.
- Object storage (e.g., Cloudflare R2) for large content like email bodies, call recordings, and attachments.
- Potentially other services for event-driven workflows (e.g., `hr-service` or `finance-service` for referral bonuses).

*(Full OpenAPI/Swagger specifications will provide complete details for all API endpoints, request/response schemas, and authentication mechanisms. Links to the AI Integration Strategy and overall CRM feature list documents provide further context.)*
```
