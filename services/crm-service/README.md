# CRM Service (@easycode/crm-service)

## 1. Service Overview

Manages customer data, sales pipeline, marketing campaigns, and customer support interactions. This service provides a comprehensive platform for managing all aspects of customer relationships, including lead and contact management, sales automation, multi-channel communication, and basic customer service interactions. It is designed to be adaptable for various business needs.

## 2. Tech Stack

Built with TypeScript and Node.js, leveraging Turborepo for monorepo management. It's designed for deployment on cloud infrastructure, compatible with strategies like OpenNext/Cloudflare for relevant parts of the ecosystem.

## 3. Core Features and Capabilities

The `crm-service` includes a broad range of functionalities. While initial focus for certain clients (e.g., Stema) may highlight specific data models and APIs, the general capabilities are extensive.

### 3.1. Lead Management
1.  Lead capture (web forms, API, import).
2.  Customizable lead qualification & scoring rules.
3.  Automated lead assignment (round-robin, rule-based).
4.  Lead nurturing sequences.
5.  Duplicate detection & merging.
6.  Conversion tracking (to opportunity/contact/account).
7.  **Referral Management (Stema Focus):**
    7.1. Track leads generated by internal employee referrals.
    7.2. Capture referral details and link to the referring employee.

### 3.2. Contact & Account Management
1.  360-degree view of contacts and accounts (organizations).
2.  Customizable fields and page layouts.
3.  Relationship mapping (e.g., key contacts, reporting structures, inter-account relationships).
4.  Comprehensive activity timelines for all interactions (see Communication Logging).
5.  Data import/export.
6.  Segmentation tools.
7.  Data enrichment capabilities (future).

### 3.3. Sales Pipeline & Opportunity Management
1.  Multiple customizable sales pipelines.
2.  Drag-and-drop deal stage management.
3.  Opportunity tracking (value, probability, expected close date, key stakeholders).
4.  Sales forecasting.
5.  Quote generation (basic).
6.  Sales activity management.

### 3.4. Communication Logging & Unified Communications (Customer Knowledge Base)
A core capability is logging all customer interactions to build a comprehensive knowledge base.
1.  **Base `Activity` Model**: Captures common metadata for all communications (e.g., `activityId`, `tenantId`, `contactId`, `userId`, `activityTimestamp`, `direction`, `summary`, `visibility`).
2.  **Specific Communication Types:**
    2.1. **`EmailActivity`**: Tracks subject, from/to/cc/bcc, body preview, gateway IDs, thread ID, attachments. Full bodies/attachments stored in object storage.
    2.2. **`CallActivity`**: Logs phone number, duration, outcome, references to recordings/notes in object storage.
    2.3. **`SmsActivity` & `WhatsAppActivity`**: Store message bodies (or references), identifiers, status, media details (large media in object storage).
    2.4. **`NoteActivity` (Internal)**: For internal employee notes related to contacts/accounts.
    2.5. **`MeetingActivity`**: Details subject, times, location, attendees, references to notes/agendas.
3.  Integrations for Email, Telephony, SMS, WhatsApp to feed the Activity Logging system.
4.  Shared team inboxes (conceptually part of Email Collaboration).
5.  Advanced email templates with personalization.
6.  Email tracking (opens, clicks, bounces).
7.  Automated email sequences.

### 3.5. Marketing Automation
1.  Multi-step marketing campaign builder (email, SMS, potentially social).
2.  Audience segmentation for campaigns.
3.  A/B testing for emails/landing pages.
4.  Landing page builder or integration.
5.  Lead capture forms for campaigns.
6.  Marketing ROI analytics.
7.  Basic social media posting/monitoring (future).

### 3.6. Customer Service/Support Ticketing (Lite)
1.  Basic case/ticket creation from emails or manual entry.
2.  Ticket assignment to agents/teams.
3.  Status tracking.
4.  Internal comments on tickets.
5.  Linking tickets to customer records.
6.  Basic knowledge base integration (or a simple internal FAQ system).
    *(Note: If this becomes very complex, it could justify its own `customer-support-service`)*

### 3.7. Workflow Automation Engine
1.  Rule-based automation for routine tasks.
2.  Automated email/SMS alerts based on triggers.
3.  Field updates based on criteria.
4.  Approval process automation.

### 3.8. Reporting & Analytics
1.  Customizable dashboards for sales, marketing, and service.
2.  Advanced report builder with drag-and-drop interface.
3.  Sales performance analytics.
4.  Marketing campaign effectiveness.
5.  Customer lifecycle analytics.
6.  Data export options.
7.  **Referral Reporting (Stema Focus):** Dedicated reports for aggregated referral performance data.

### 3.9. Administration & Customization
1.  User role and permission management (integrated with `user-service`).
2.  Audit trails.
3.  Custom object creation (basic, future).
4.  API access and management.
5.  Integration marketplace/settings for third-party tools.

### 3.10. Potential AI Enhancements
The `crm-service` is planned to incorporate several AI-driven features:
1.  Predictive Lead Scoring.
2.  Sales Forecast Automation & Deal Insights.
3.  Customer Sentiment Analysis.
4.  Intelligent Product/Service Recommendations.
5.  Automated Communication Summarization.

## 4. Key API Endpoints (Illustrative - Stema Focus)

The following API endpoints illustrate how core features are exposed, with a focus on Stema's initial requirements. All endpoints are versioned (e.g., `/v1/...`) and require authentication/authorization. `tenantId` is typically derived from the user's session.

### 4.1. Logging Communication Activities
-   `POST /v1/activities/emails` - Logs an email activity.
-   `POST /v1/activities/calls` - Logs a call activity.
-   `POST /v1/activities/sms` - Logs an SMS activity.
-   `POST /v1/activities/whatsapp` - Logs a WhatsApp activity.
-   `POST /v1/activities/notes` - Logs an internal note.
-   `POST /v1/activities/meetings` - Logs a meeting activity.

### 4.2. Retrieving Communication History (Activity Feed)
-   `GET /v1/contacts/{contactId}/activity-feed`
-   `GET /v1/accounts/{accountId}/activity-feed`
    (Supports extensive query parameters for filtering and sorting)

### 4.3. Lead Management APIs for Referrals
-   `POST /v1/leads` (accepts `referred_by_employee_id`, `referral_details`)
-   `GET /v1/leads` (supports querying by referral data)
-   `GET /v1/reports/employee-lead-referrals` (for aggregated referral data)

*(Full OpenAPI/Swagger specifications will provide complete details for all API endpoints, request/response schemas, and authentication mechanisms.)*

## 5. Key Integration Points with Other Services

-   **`user-service`**: For user authentication, authorization, and to resolve user details (e.g., `referred_by_employee_id` in leads). CRM user roles and permissions are managed in conjunction with `user-service`.
-   **`tenant-service`**: For tenant-specific configurations, ensuring data isolation and customized settings per tenant. All data within the CRM is tenant-isolated.
-   **`notification-service`**: For dispatching certain types of system alerts, reminders, or potentially for aspects of marketing campaigns (though many communications are managed directly by CRM channel modules).
-   **`finance-service`**: For potential integration regarding invoicing customers based on CRM data (e.g., converted deals, subscription levels) or for financial data related to customer value. Can also consume events like `LeadReferredAndConverted` for bonus/commission processing if applicable.
-   **Object Storage (e.g., Cloudflare R2, AWS S3)**: For storing large content like email bodies, call recordings, and attachments, referenced by activities in the CRM database.
-   **Other Event Consumers**: Services like HR or dedicated bonus processing services might consume events (e.g., `LeadReferredAndConverted`) published by `crm-service`.

## 6. Frontend & UI Consumption

Provides APIs and data structures that can be consumed by frontend applications, potentially built using components from the shared UI library in `apps/main-ui/`, to deliver a consistent user experience for CRM functionalities.

*(Links to the AI Integration Strategy and overall CRM feature list documents would provide further context if available.)*
